{% extends "base.html" %}
{% block title %}{{ event.title }} — Teatro{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Información del evento -->
        <div class="event-header">
            <div class="event-info">
                <h1 class="event-title">{{ event.title }}</h1>
                <div class="event-meta-grid">
                    <div class="event-meta-item">
                        <span class="meta-icon">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </span>
                        <span>{{ event.venue_name }}</span>
                    </div>
                    <div class="event-meta-item">
                        <span class="meta-icon">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </span>
                        <span>{{ event.start_time[:16].replace('T', ' · ') }}</span>
                    </div>
                    <div class="event-meta-item">
                        <span class="meta-icon">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </span>
                        <span>${{ "%.2f"|format(event.price) }} por asiento</span>
                    </div>
                    <div class="event-meta-item">
                        <span class="meta-icon">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                        </span>
                        <span>Máx. {{ event.max_per_user }} boletos por persona</span>
                    </div>
                </div>
                {% if event.description %}
                <p class="event-description">{{ event.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Leyenda -->
        <div class="seat-legend">
            <div class="legend-item"><span class="legend-color legend-free"></span>Libre</div>
            <div class="legend-item"><span class="legend-color legend-selected"></span>Seleccionado</div>
            <div class="legend-item"><span class="legend-color legend-my-sold"></span>Tus Asientos</div>
            <div class="legend-item"><span class="legend-color legend-sold"></span>Ocupado</div>
        </div>

        <!-- Escenario -->
        <div class="stage-label">
            <span>ESCENARIO</span>
        </div>

        <!-- Loading -->
        <div id="seat-loading" class="loading-indicator">
            <div class="spinner"></div>
            <span>Cargando mapa de asientos...</span>
        </div>

        <!-- Barra de Estado de Límites (Nuevo UX) -->
        <div id="limit-status-bar" class="limit-status-bar" style="display: none;">
            <div class="limit-content">
                <div class="limit-text">
                    <strong id="limit-main-text">Iniciando...</strong>
                    <span id="limit-sub-text" class="text-muted">Calculando cupo...</span>
                </div>
                <div class="limit-indicator">
                    <span id="limit-count">0/0</span>
                </div>
            </div>
            <div class="limit-progress-track">
                <div id="limit-progress-fill" class="limit-progress-fill" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Mapa de asientos -->
        <div class="map-wrapper" style="position: relative;">
            <div id="seat-map" class="seat-map" style="display:none;" data-event-id="{{ event.id }}"
                data-rows="{{ event.rows_count }}" data-cols="{{ event.cols_count }}">
                <!-- Contenido generado por JS -->
            </div>
        </div>

        <!-- Panel de selección -->
        <div id="selection-panel" class="selection-panel" style="display:none;">
            <div class="selection-info">
                <h3>Tu selección</h3>
                <div id="selected-seats-list" class="selected-seats-list"></div>
                <div class="selection-total">
                    <span>Total:</span>
                    <span id="selection-total" class="total-amount">$0.00</span>
                </div>
            </div>
            <div class="selection-actions">
                <button id="btn-hold" class="btn btn-primary btn-lg" onclick="holdSeats()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Reservar (10 min)
                </button>
                <button id="btn-clear" class="btn btn-outline btn-lg" onclick="clearSelection()"
                    style="margin-left: 10px;">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Limpiar
                </button>
            </div>
        </div>

        <!-- Panel de confirmación (después del HOLD) -->
        <div id="confirm-panel" class="confirm-panel" style="display:none;">
            <div class="confirm-info">
                <h3>
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round"
                        style="vertical-align: text-bottom; margin-right: 5px;">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Asientos reservados
                </h3>
                <p>Tienes <strong id="hold-minutes">10</strong> minutos para confirmar la compra.</p>
                <div class="hold-timer">
                    <span class="timer-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </span>
                    <span id="hold-countdown" class="countdown">10:00</span>
                </div>
                <div id="held-seats-list" class="selected-seats-list"></div>
                <div class="selection-total">
                    <span>Total a pagar:</span>
                    <span id="confirm-total" class="total-amount">$0.00</span>
                </div>
            </div>
            <div class="selection-actions">
                <button id="btn-confirm" class="btn btn-success btn-lg" onclick="confirmPurchase()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Confirmar Compra
                </button>
                <button id="btn-cancel-hold" class="btn btn-outline btn-lg" onclick="releaseHold()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Cancelar
                </button>
            </div>
        </div>

        <!-- Modal de éxito -->
        <div id="success-modal" class="modal" style="display:none;">
            <div class="modal-card">
                <div class="modal-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <h2>¡Compra exitosa!</h2>
                <p>Tus tickets han sido generados.</p>
                <div id="tickets-list" class="tickets-result"></div>
                <a href="{{ url_for('my_tickets') }}" class="btn btn-primary btn-lg">Ver Mis Tickets</a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const EVENT_ID = {{ event.id }};
    const EVENT_PRICE = {{ event.price }};
    const EVENT_ROWS = {{ event.rows_count }};
    const EVENT_COLS = {{ event.cols_count }};
    const MAX_PER_USER = {{ event.max_per_user }};
    const CURRENT_USER_ID = {{ user.user_id if user else 'null' }};
</script>
<script src="{{ url_for('static', filename='js/seating.js') }}?v=13"></script>
{% endblock %}